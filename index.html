<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gemini Quick Chat (Webview)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Ensure the body and html take full height for flexbox to work */
      html,
      body {
        height: 100%;
        margin: 0;
        overflow: hidden; /* Prevent body scrollbar */
      }

      /* Styling for the main container to fill the window */
      .main-container {
        display: flex;
        flex-direction: row;
        height: 100%;
        background-color: rgba(
          31,
          41,
          55,
          0.95
        ); /* Semi-transparent dark background */
        border-radius: 12px; /* Rounded corners for the entire window */
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4); /* Subtle shadow */
        overflow: hidden; /* Ensure rounded corners clip content */
      }

      /* Style the webview to fill the container */
      webview {
        flex-grow: 1; /* Allow webview to take available space */
        border-radius: 10px; /* Apply rounded corners to the webview */
        overflow: hidden; /* Ensure content within webview respects border-radius */
        width: 100%;
        height: 100%;
      }

      .buttons {
        position: absolute;
        top: 0;
        left: 0;
        z-index: 10;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 12px;
        width: 10px;
        height: 100%;
        background-color: rgba(17, 24, 39, 0.8);
        transition: all 0.3s ease;
        overflow: hidden;
        padding: 12px 0;
      }

      .buttons:hover {
        width: 80px;
        padding: 12px;
        background-color: rgba(17, 24, 39, 0.95);
        backdrop-filter: blur(10px);
        box-shadow: 4px 0 20px rgba(0, 0, 0, 0.3);
        border-radius: 0 12px 12px 0;
      }

      .app-button {
        position: relative;
        background-color: rgba(55, 65, 81, 0.6);
        border: 2px solid rgba(75, 85, 99, 0.5);
        cursor: pointer;
        padding: 12px;
        border-radius: 12px;
        transition: all 0.3s ease;
        backdrop-filter: blur(8px);
      }

      .app-button:hover {
        background-color: rgba(79, 70, 229, 0.3);
        border-color: rgba(99, 102, 241, 0.7);
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(99, 102, 241, 0.2);
      }

      .app-button.selected {
        background-color: rgba(99, 102, 241, 0.4);
        border-color: rgba(99, 102, 241, 0.8);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
      }

      .app-button.selected:hover {
        background-color: rgba(99, 102, 241, 0.5);
        transform: translateY(-1px);
      }

      .app-button img {
        width: 32px;
        height: 32px;
        transition: all 0.3s ease;
        filter: brightness(0.9);
      }

      .app-button:hover img {
        transform: scale(1.1);
        filter: brightness(1.1);
      }

      .app-button.selected img {
        filter: brightness(1.2);
      }
    </style>
  </head>
  <body class="font-sans antialiased text-gray-100">
    <div class="main-container">
      <div class="buttons">
        <button class="app-button selected" data-app="gemini">
          <img src="./static/gemini.png" alt="Gemini" />
        </button>
        <button class="app-button" data-app="notebooklm">
          <img src="./static/notebooklm.svg" alt="NotebookLM" />
        </button>
      </div>
      <webview
        id="geminiWebview"
        src="https://gemini.google.com/app"
        class="w-full h-full"
        partition="persist:gemini"
        allowpopups
      ></webview>
    </div>

    <script>
      (() => {
        const buttons = document.querySelectorAll("button[data-app]");
        buttons.forEach((button) => {
          button.addEventListener("click", (event) => {
            const app = event.currentTarget.getAttribute("data-app");
            console.log(`[Button Click] App selected: ${app}`);

            // Update selected state
            buttons.forEach((btn) => btn.classList.remove("selected"));
            event.currentTarget.classList.add("selected");

            // Send message to main process to change webview src
            window.electronAPI.changeWebviewSrc(app);
          });
        });
      })();

      const geminiWebview = document.getElementById("geminiWebview");

      /**
       * Function to be triggered when the webview's page changes (in-page navigation).
       * @param {string} newUrl - The new URL after the navigation.
       */
      function onGeminiPageChange(newUrl) {
        console.log(`[Webview Navigation] Page changed to: ${newUrl}`);
        // Trigger scroll to bottom after a short delay to allow content to render
        // Only attempt to scroll if the current URL is Gemini's chat interface
        if (newUrl.startsWith("https://gemini.google.com/app")) {
          setTimeout(scrollGeminiChatToBottom, 500); // 500ms delay
        }
      }

      // NEW: Listen for 'change-webview-src' message from the main process
      window.electronAPI.onChangeWebviewSrc((event, newSrc) => {
        console.log(
          `[Webview SRC Change] Changing webview source to: ${newSrc}`
        );
        geminiWebview.src = newSrc;

        // Update button selection based on the new source
        const buttons = document.querySelectorAll("button[data-app]");
        buttons.forEach((btn) => btn.classList.remove("selected"));

        if (newSrc.includes("gemini.google.com")) {
          document
            .querySelector('button[data-app="gemini"]')
            .classList.add("selected");
        } else if (newSrc.includes("notebooklm.google.com")) {
          document
            .querySelector('button[data-app="notebooklm"]')
            .classList.add("selected");
        }

        // After changing src, you might want to re-focus or re-scroll after it loads
        geminiWebview.addEventListener("did-finish-load", function handler() {
          console.log(
            `[Webview SRC Change] New source finished loading: ${newSrc}`
          );

          // Remove the listener to prevent multiple calls
          geminiWebview.removeEventListener("did-finish-load", handler);
        });
      });

      // Optional: Handle webview's 'did-fail-load' event
      geminiWebview.addEventListener("did-fail-load", (event) => {
        console.error(
          "Webview failed to load:",
          event.errorCode,
          event.errorDescription,
          event.validatedURL
        );
      });

      // Listen for 'did-navigate-in-page' event (for SPA internal navigation)
      geminiWebview.addEventListener("did-navigate-in-page", (event) => {
        onGeminiPageChange(event.url);
      });

      // Focus the webview when the window loads
      geminiWebview.focus();
    </script>
  </body>
</html>
