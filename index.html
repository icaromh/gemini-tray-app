<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gemini Quick Chat (Webview)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Ensure the body and html take full height for flexbox to work */
      html,
      body {
        height: 100%;
        margin: 0;
        overflow: hidden; /* Prevent body scrollbar */
      }

      /* Styling for the main container to fill the window */
      .main-container {
        display: flex;
        flex-direction: column;
        height: 100%;
        background-color: rgba(
          31,
          41,
          55,
          0.95
        ); /* Semi-transparent dark background */
        border-radius: 12px; /* Rounded corners for the entire window */
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4); /* Subtle shadow */
        overflow: hidden; /* Ensure rounded corners clip content */
      }

      /* Style the webview to fill the container */
      webview {
        flex-grow: 1; /* Allow webview to take available space */
        border-radius: 10px; /* Apply rounded corners to the webview */
        overflow: hidden; /* Ensure content within webview respects border-radius */
      }
    </style>
  </head>
  <body class="font-sans antialiased text-gray-100">
    <div class="main-container">
      <webview
        id="geminiWebview"
        src="https://gemini.google.com/app"
        class="w-full h-full"
        partition="persist:gemini"
        allowpopups
      ></webview>
    </div>

    <script>
      const geminiWebview = document.getElementById("geminiWebview");

      /**
       * Function to be triggered when the webview's page changes (in-page navigation).
       * @param {string} newUrl - The new URL after the navigation.
       */
      function onGeminiPageChange(newUrl) {
        console.log(`[Webview Navigation] Page changed to: ${newUrl}`);
        // Trigger scroll to bottom after a short delay to allow content to render
        // Only attempt to scroll if the current URL is Gemini's chat interface
        if (newUrl.startsWith("https://gemini.google.com/app")) {
          setTimeout(scrollGeminiChatToBottom, 500); // 500ms delay
        }
      }

      /**
       * Injects JavaScript into the webview to scroll the chat history to the bottom.
       * This function needs to be called after the content has loaded/rendered.
       */
      function scrollGeminiChatToBottom() {
        if (!geminiWebview) {
          console.warn("[Scroll] webview element not found.");
          return;
        }

        const scriptToInject = `
                (function() {
                    const chatContainer = document.querySelector('div[role="main"] div[tabindex="0"][aria-label]');
                    if (chatContainer) {
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                        console.log('Scrolled Gemini chat to bottom.');
                    } else {
                        console.warn('Gemini chat container not found for scrolling.');
                    }
                })();
            `;

        geminiWebview
          .executeJavaScript(scriptToInject)
          .then(() => console.log("[Scroll] Scroll script injected."))
          .catch((error) =>
            console.error(
              "[Scroll ERROR] Failed to inject scroll script:",
              error
            )
          );
      }

      // Listen for the 'focus-webview-input' message from the main process
      window.electronAPI.onFocusWebviewInput(() => {
        geminiWebview
          .executeJavaScript(
            `
                (function() {
                    const input = document.querySelector('textarea[aria-label="Chat input"]');
                    if (input) {
                        input.focus();
                        input.click();
                    } else {
                        console.warn('Gemini chat input not found in webview.');
                    }
                })();
            `
          )
          .catch((error) => {
            console.error("Error executing script in webview:", error);
          });
      });

      // NEW: Listen for 'change-webview-src' message from the main process
      window.electronAPI.onChangeWebviewSrc((event, newSrc) => {
        console.log(
          `[Webview SRC Change] Changing webview source to: ${newSrc}`
        );
        geminiWebview.src = newSrc;
        // After changing src, you might want to re-focus or re-scroll after it loads
        geminiWebview.addEventListener("did-finish-load", function handler() {
          console.log(
            `[Webview SRC Change] New source finished loading: ${newSrc}`
          );
          // Attempt to focus input or scroll to bottom after load
          if (newSrc.startsWith("https://gemini.google.com/app")) {
            setTimeout(scrollGeminiChatToBottom, 1000); // Give it time to render
          }
          // Remove the listener to prevent multiple calls
          geminiWebview.removeEventListener("did-finish-load", handler);
        });
      });

      // Optional: Handle webview's 'did-fail-load' event
      geminiWebview.addEventListener("did-fail-load", (event) => {
        console.error(
          "Webview failed to load:",
          event.errorCode,
          event.errorDescription,
          event.validatedURL
        );
      });

      // Optional: Handle webview's 'dom-ready' event
      geminiWebview.addEventListener("dom-ready", () => {
        console.log("Gemini webview DOM is ready.");
        // Initial scroll attempt after DOM is ready, only if it's Gemini
        if (geminiWebview.src.startsWith("https://gemini.google.com/app")) {
          setTimeout(scrollGeminiChatToBottom, 1000);
        }
      });

      // Listen for 'did-navigate-in-page' event (for SPA internal navigation)
      geminiWebview.addEventListener("did-navigate-in-page", (event) => {
        onGeminiPageChange(event.url);
      });

      // Also listen for full 'did-navigate' events
      geminiWebview.addEventListener("did-navigate", (event) => {
        console.log(`[Webview Navigation] Full navigation to: ${event.url}`);
        onGeminiPageChange(event.url);
      });

      // Event listener for Escape key to hide the window
      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
          window.electronAPI.closeWindow();
        }
      });

      // Focus the webview when the window loads
      geminiWebview.focus();
    </script>
  </body>
</html>
